<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Thinkpad T420 Temperature-Multiplier Analysis - Fabian's Website</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://0x0b.de/favicon.ico" rel="icon">

<link rel="canonical" href="https://0x0b.de/thinkpad-t420-temperature-multiplier-analysis.html">

        <meta name="author" content="Fabian Hirschmann" />
        <meta name="keywords" content="linux,t420" />
        <meta name="description" content="I recently ran into the problem that games would not run fluently on my Thinkpad T420 with an nVidia NVS 4200M. While I&#39;m not exactly a gamer, I do like to play causally every two or three months. What bothered me was that even games that don&#39;t require ..." />

        <meta property="og:site_name" content="Fabian's Website" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Thinkpad T420 Temperature-Multiplier Analysis"/>
        <meta property="og:url" content="https://0x0b.de/thinkpad-t420-temperature-multiplier-analysis.html"/>
        <meta property="og:description" content="I recently ran into the problem that games would not run fluently on my Thinkpad T420 with an nVidia NVS 4200M. While I&#39;m not exactly a gamer, I do like to play causally every two or three months. What bothered me was that even games that don&#39;t require ..."/>
        <meta property="article:published_time" content="2012-12-22" />
            <meta property="article:section" content="misc" />
            <meta property="article:tag" content="linux" />
            <meta property="article:tag" content="t420" />
            <meta property="article:author" content="Fabian Hirschmann" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://0x0b.de/theme/css/bootstrap.yeti.min.css" type="text/css"/>
    <link href="https://0x0b.de/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://0x0b.de/theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="https://0x0b.de/theme/css/style.css" type="text/css"/>


        <link href="https://0x0b.de/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Fabian's Website ATOM Feed"/>



        <link href="https://0x0b.de/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate"
              title="Fabian's Website misc ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://0x0b.de/" class="navbar-brand">
Fabian's Website            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://0x0b.de/pages/about-me.html">
                             About Me
                          </a></li>
                         <li><a href="https://0x0b.de/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="https://0x0b.de/pages/publications.html">
                             Publications
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://0x0b.de/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://0x0b.de/thinkpad-t420-temperature-multiplier-analysis.html"
                       rel="bookmark"
                       title="Permalink to Thinkpad T420 Temperature-Multiplier Analysis">
                        Thinkpad T420 Temperature-Multiplier Analysis
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2012-12-22T16:48:00+01:00"> Sat 22 December 2012</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://0x0b.de/tag/linux.html">linux</a>
        /
	<a href="https://0x0b.de/tag/t420.html">t420</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I recently ran into the problem that games would not run fluently on my Thinkpad
T420 with an nVidia NVS 4200M. While I'm not exactly a gamer, I do like to play
causally every two or three months. What bothered me was that even games that
don't require much computing and graphic power tend to have frequent "hiccups".</p>
<p>What I call "hiccups" are short freezes of at most four seconds. When I started
researching the issue, it took me a while to pinpoint the exact cause of this.
The T420 features a i5-2520M CPU which is equipped with
<a href="http://www.intel.com/content/www/us/en/architecture-and-technology/turbo-boost/turbo-boost-technology.html">Intel Turbo Boost</a>
which basically means the CPU will run above the base operating frequency when
the operating system requests the highest performance state (P0). I have seen
frequencies peak at 3.2GHz whereas the base frequency is 2.5GHz.</p>
<h2>Intel Turbo Boost on Linux</h2>
<p>The Turbo Boost settings are stored in Machine Specific Registers (MSR) which
can be read from and written to using <code>msr-tools</code>. On Debian, the tools can be
installed via</p>
<div class="highlight"><pre>apt-get install msr-tools
modprobe msr
</pre></div>


<p>Once installed, the status of Turbo Mode can be read (on a T420) by executing</p>
<div class="highlight"><pre><span class="nv">$ </span>rdmsr 0x1a0 --bitfield 38:38
0
</pre></div>


<p>Where 0 indicates that TB is enabled. The current multiplier can be queried by issuing</p>
<div class="highlight"><pre><span class="nv">$ </span>rdmsr 0x198 --decimal --bitfield 15:8
8
</pre></div>


<p>Please note that <code>/proc/cpuinfo</code> will not tell you the correct frequency when TB
is enabled, because it will only ever show you the maximum frequency reported, which is 2.5GHz.</p>
<p>You can disable Turbo Mode on a T420 by calling</p>
<div class="highlight"><pre>wrmsr 0x1a0 274886623368
</pre></div>


<p>and enable it again by running</p>
<div class="highlight"><pre>wrmsr 0x1a0 8716424
</pre></div>


<p>If you want to know more about these registers, I recommend taking a look
at <a href="http://code.google.com/p/i7z/">i7z</a>.</p>
<h2>T420 under High Load</h2>
<p>Back to the hiccups. The reason they exist is that the T420 cooling system
is unable to absorb the heat over long periods of time. The following graph
shows the development of the temperature and the clock multiplier with Turbo
Mode and Hyper-Threading enabled while running
<a href="http://weather.ou.edu/~apw/projects/stress/">stress</a> with 4 worker threads.</p>
<p><img alt="4 Threads, Turbo On, Hyper-Threading on" src="/images/data_c4_t1_h1.png" /></p>
<p>The graph shows that the multiplier decreases to 8 when the temperatures hits
the maximum allowed temperature. This is very unfortunate, because in interactive
programs like games, the user will experience stuttering until the multiplier is
increased again.</p>
<p>It seems to be less of a problem when we stress the CPU with only 1 worker thread,
even though this will raise the multiplier even higher.</p>
<p><img alt="1 Threads, Turbo On, Hyper-Threading on" src="/images/data_c1_t1_h1.png" /></p>
<p>After turning Turbo Boost off, there are no more sudden multiplier drops:</p>
<p><img alt="4 Threads, Turbo Off, Hyper-Threading on" src="/images/data_c4_t0_h1.png" /></p>
<p>The tests I conducted are dependent on the ambient temperature -- frequent hiccups
may not be as reproducible in a setting with low ambient temperatures. I conducted
the tests with an ambient temperature of 25.5 °C.</p>
<h2>Conclusion</h2>
<p>Intel Turbo Boost is supposed to decrease the multiplier in increments and not use
an all-or-nothing approach when thermal limits are reached. Unfortunately, this is
not what happens here.</p>
<p>Therefore, I recommend disabling Turbo Boost on a T420 with an nVidia NVS 4200M  if
you have real-time computing needs and experience stuttering in games for example.</p>
<p>If you don't want to go through the trouble of installing msr-tools and setting the
registers, an alternative way of setting the maximum frequency is</p>
<div class="highlight"><pre><span class="x">echo &quot;for i in 0 1 2 3; do cpufreq-set -c </span><span class="p">$</span><span class="nv">i</span><span class="x"> -g ondemand -u 2.50GHz; done&quot; &gt;&gt; /etc/rc.local</span>
</pre></div>


<p>on Debian.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = '0x0b'; // required: replace example with your forum shortname

                    var disqus_identifier = 'thinkpad-t420-temperature-multiplier-analysis';
                var disqus_url = 'https://0x0b.de/thinkpad-t420-temperature-multiplier-analysis.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
	<div class="container">
		<hr>
		<div class="row">
			<div class="col-xs-10">&copy; 2009 – 2015 Fabian Hirschmann
				&middot; <a href="https://0x0b.de/pages/legal-notice.html">legal notice</a>
				&middot; <a href="https://0x0b.de/pages/datenschutzerklarung.html">privacy statement</a>			</div>
			<div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
		</div>
		<div class="row pull-right">
			<ul class="list-group" id="social">
				<li class="list-group-item"><a href="https://github.com/fhirschmann"><i class="fa fa-github fa"></i> Github</a></li>
				<li class="list-group-item"><a href="mailto:fabian@hirschmann.email"><i class="fa fa-pencil fa"></i> Mail</a></li>
				<li class="list-group-item"><a href="http://www.facebook.com/fhirschmann"><i class="fa fa-facebook fa"></i> Facebook</a></li>
				<li class="list-group-item"><a href="http://www.linkedin.com/in/fhirschmann"><i class="fa fa-linkedin fa"></i> LinkedIn</a></li>
				<li class="list-group-item"><a href="https://www.xing.com/profile/Fabian_Hirschmann2"><i class="fa fa-xing fa"></i> Xing</a></li>
				<li class="list-group-item"><a href="bitcoin:16Mhwr5U9JVvVLEGwyPqyR1WE8qaJtzsin"><i class="fa fa-bitcoin fa"></i> BTC</a></li>
			</ul>
		</div>
	</div>
</footer>
<script src="https://0x0b.de/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://0x0b.de/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://0x0b.de/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = '0x0b'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->

</body>
</html>